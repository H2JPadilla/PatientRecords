@model EL.PatientEntity
@{
    ViewBag.Title = "Add Patient";
}

<h2>Add Patient</h2>

@using (Html.BeginForm("AddPatient", "Patient", FormMethod.Post, new { id = "patientForm" }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(false, "", new { @class = "text-danger" })

    @Html.Partial("Partial/PatientForm", Model)

    <button type="button" class="btn btn-success" id="saveButton">Save</button>
    <a href="@Url.Action("ViewPatient")" class="btn btn-secondary">Cancel</a>
}

<div class="modal fade" id="saveModal" tabindex="-1" aria-labelledby="saveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveModalLabel">Confirm Save</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">Do you want to save this patient record?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" id="confirmSaveBtn">Yes, Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var saveModal = new bootstrap.Modal(document.getElementById('saveModal'));

            document.getElementById('saveButton').addEventListener('click', function () {
                if (validateForm()) {
                    saveModal.show();
                }
            });

            document.getElementById('confirmSaveBtn').addEventListener('click', function () {
                document.getElementById('patientForm').submit();
            });

            function validateForm() {
                let isValid = true;
                const patientInput = document.getElementById('Patient');
                const drugInput = document.getElementById('DrugName');
                const dosageInput = document.getElementById('Dosage');

                // Clear previous errors
                document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

                if (patientInput.value.trim() === '') {
                    patientInput.classList.add('is-invalid');
                    isValid = false;
                }
                if (drugInput.value.trim() === '') {
                    drugInput.classList.add('is-invalid');
                    isValid = false;
                }
                const dosageValue = parseInt(dosageInput.value, 10);
                if (dosageInput.value.trim() === '' || isNaN(dosageValue) || dosageValue <= 0) {
                    dosageInput.classList.add('is-invalid');
                    isValid = false;
                }

                if (!isValid) {
                    const firstInvalid = document.querySelector('.is-invalid');
                    if (firstInvalid) {
                        firstInvalid.focus();
                    }
                }
                return isValid;
            }

            // Remove red highlight when user starts typing
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', function () {
                    this.classList.remove('is-invalid');
                });
            });
        });
    </script>
}